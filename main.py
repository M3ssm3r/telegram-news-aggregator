# -*- coding: utf-8 -*-

# –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π, —á—Ç–æ–±—ã –¥–µ—Ä–∂–∞—Ç—å —Ä—É–∫—É –Ω–∞ –ø—É–ª—å—Å–µ.
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ –∫—Ä–æ–Ω—É —Ä–∞–∑ –≤ —á–∞—Å.

import feedparser
import telegram
import os # –ò—Å–ø–æ–ª—å–∑—É–µ–º os –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

# --- –ö–û–ù–§–ò–ì ---
# –õ—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, –∞ –Ω–µ –≤ –∫–æ–¥–µ.
# –ù–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –º–æ–∂–Ω–æ –∏ –Ω–∞–ø—Ä—è–º—É—é –≤–ø–∏—Å–∞—Ç—å.
TELEGRAM_BOT_TOKEN = os.environ.get('TG_BOT_TOKEN', 'YOUR_TELEGRAM_BOT_TOKEN') # –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–∞–µ–º —É @BotFather
TELEGRAM_CHANNEL_ID = os.environ.get('TG_CHANNEL_ID', '@your_channel_name')   # ID –∫–∞–Ω–∞–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä @my_cool_news

RSS_URL = 'https://habr.com/ru/rss/hubs/all/'
POSTS_LIMIT = 5 # –°–∫–æ–ª—å–∫–æ –Ω–æ–≤–æ—Å—Ç–µ–π –±–µ—Ä–µ–º –∑–∞ —Ä–∞–∑

def get_latest_news(url):
    """
    –û—Å–Ω–æ–≤–Ω–∞—è –º–∞–≥–∏—è. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ RSS –∏ –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ—Ç –ø–æ—Å—Ç—ã.
    feedparser - –∫—Ä—É—Ç–∞—è —à—Ç—É–∫–∞, –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–µ—Ç –ø–æ—á—Ç–∏ –ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç.
    """
    print(f"–ü–∞—Ä—Å–∏–Ω–≥ {url}...")
    feed = feedparser.parse(url)
    if feed.bozo: # bozo=1 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ RSS –∫—Ä–∏–≤–æ–π. –°—Ç–æ–∏—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å.
        print(f"–í–Ω–∏–º–∞–Ω–∏–µ: RSS-–ª–µ–Ω—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π. {feed.bozo_exception}")
    
    news_list = []
    # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º –∑–∞–ø–∏—Å—è–º –∏ –∑–∞–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    for entry in feed.entries[:POSTS_LIMIT]:
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –∫—Ä–∞—Å–∏–≤–æ
        news_list.append(f"üìå {entry.title.strip()}")
    return "\n".join(news_list)

def send_to_telegram(message):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ–ª–µ–≥—É.
    –û–±–µ—Ä–Ω—É–ª –≤ try-except –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ API —Ç–µ–ª–µ–≥–∏ –ª—è–∂–µ—Ç –∏–ª–∏ —Ç–æ–∫–µ–Ω –±—É–¥–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π.
    """
    if not message:
        print("–ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.")
        return

    try:
        print("–ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ Telegram API...")
        bot = telegram.Bot(token=TELEGRAM_BOT_TOKEN)
        bot.send_message(chat_id=TELEGRAM_CHANNEL_ID, text=message, parse_mode='HTML')
        print("–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–Ω–∞–ª!")
    except Exception as e:
        # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, —Ö–æ—Ç—è –±—ã —É–≤–∏–¥–∏–º –æ—à–∏–±–∫—É –≤ –ª–æ–≥–∞—Ö
        print(f"–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. {e}")

# --- –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ---
if __name__ == "__main__":
    print("====== –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞ –Ω–æ–≤–æ—Å—Ç–µ–π ======")
    news = get_latest_news(RSS_URL)
    
    full_message = f"<b>üî• –°–≤–µ–∂–∞–∫ —Å –•–∞–±—Ä–∞:</b>\n\n{news}"
    
    send_to_telegram(full_message)
    print("====== –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É ======")
